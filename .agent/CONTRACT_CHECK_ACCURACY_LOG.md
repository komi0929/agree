# agree 契約書チェック精度向上ログ

> **このドキュメントの目的**: 契約書チェック精度向上に関するすべての設計判断、実装履歴、検討事項を記録し、将来の改善検討の基盤とする。

---

## 目次

1. [設計思想](#設計思想)
2. [アーキテクチャ変遷](#アーキテクチャ変遷)
3. [実装履歴](#実装履歴)
4. [検討したが採用しなかったアイデア](#検討したが採用しなかったアイデア)
5. [既知の課題と将来の改善候補](#既知の課題と将来の改善候補)

---

## 設計思想

### 根本原則

1. **LLMは補助、ルールは必須**
   - LLMは文脈理解には優れるが、100%の検知は保証できない
   - 確定的なリスク（法律違反など）は正規表現ルールで100%検知する

2. **沈黙は危険**
   - 条項が「存在しない」ことが最大のリスクになりうる
   - 必須条項の欠落を積極的に検知する

3. **計算はコードで**
   - 60日ルールなどの数値計算はLLMに任せず、プログラムで厳密に計算

4. **多層防御**
   - 複数のレイヤーでチェックし、1つが見逃しても他で捕捉

### アーキテクチャ図

```
[契約書PDF]
     ↓
[テキスト抽出] ← pdf-service.ts
     ↓
┌─────────────────────────────────────────┐
│ Layer 1: ルールベースチェック            │ ← lib/rules/*
│ - 危険パターン正規表現                   │
│ - 必須条項存在チェック                   │
│ - 60日ルール計算                         │
└─────────────────────────────────────────┘
     ↓
┌─────────────────────────────────────────┐
│ Layer 2: 構造解析                        │ ← lib/parser/*
│ - 条項分割                               │
│ - タグ付け                               │
└─────────────────────────────────────────┘
     ↓
┌─────────────────────────────────────────┐
│ Layer 3: LLM解析                         │ ← lib/ai-service.ts
│ - コンテキスト理解                       │
│ - ニュアンス判定                         │
└─────────────────────────────────────────┘
     ↓
┌─────────────────────────────────────────┐
│ Layer 4: 統合                            │ ← lib/legal/result-merger.ts
│ - ルール結果 + LLM結果を統合              │
│ - 重複排除                               │
│ - 重要度でソート                         │
└─────────────────────────────────────────┘
     ↓
[最終結果]
```

---

## アーキテクチャ変遷

### Version 1.0 (初期実装)
- **日付**: 2024-12-24
- **構成**: LLM一発解析
- **問題点**: 
  - 見落としの可能性
  - 計算ミスの可能性
  - 再現性なし

### Version 2.0 (法的精度強化)
- **日付**: 2024-12-25
- **追加機能**:
  - ユーザー属性収集 (UserContext)
  - 法律適用判定 (law-applicability.ts)
  - 動的プロンプト生成
- **改善点**:
  - フリーランス新法/下請法の適用を正確に判定
  - ユーザーの立場に応じたリスク評価

### Version 3.0 (ハイブリッドシステム)
- **日付**: 2024-12-25
- **追加機能**:
  - ルールベースチェック (Layer 1)
  - 条項パーサー (Layer 2)
  - 既知悪質パターンDB
  - 結果統合レイヤー
- **改善点**:
  - 確定的リスクの100%検知
  - 沈黙（欠落）リスクの検知
  - 60日ルールの厳密計算

---

## 実装履歴

### [2024-12-25] Version 3.0: ハイブリッドシステム実装

#### 概要
LLM単独解析からハイブリッド・マルチレイヤーシステムへ移行。
ルールベースチェックで確定的リスクを100%検知し、LLMで文脈理解を補完。

#### 新規作成ファイル

| ファイル | 役割 |
|----------|------|
| `lib/rules/danger-patterns.ts` | 危険パターン正規表現（30+パターン） |
| `lib/rules/required-clauses.ts` | 必須条項存在チェック（5項目） |
| `lib/rules/payment-calculator.ts` | 60日ルール計算ロジック |
| `lib/rules/rule-checker.ts` | ルールベースチェック統合 |
| `lib/knowledge/known-bad-patterns.ts` | 既知の悪質パターンDB（10+パターン） |
| `lib/legal/result-merger.ts` | ルール+LLM結果統合 |

#### 検知パターン詳細

**支払遅延リスク (4パターン)**
- `翌々月末` → critical
- `90日` → critical
- `検収後60日` → high（起算点ずれ）
- `検収翌月末` → high

**損害賠償リスク (4パターン)**
- `一切の損害を賠償` → critical
- `全額賠償` → critical
- `上限なし` → critical
- `逸失利益を含む` → high

**禁止行為 (4パターン)**
- `受領を拒否できる` → critical
- `予算の都合により減額` → critical
- `不要と判断した場合は返品` → critical
- `指定ツールを契約すること` → high

**著作権リスク (2パターン)**
- `著作権を譲渡`（27/28条なし） → high
- `著作者人格権を行使しない` → medium

**偽装請負リスク (5パターン)**
- `甲の指示に従い` → high
- `甲の監督の下` → high
- `9時〜18時` → medium
- `常駐` → medium
- `再委託禁止` → medium

**競業避止リスク (2パターン)**
- `競業避止2年以上` → high
- `競合他社一切` → high

#### 必須条項チェック

| 条項 | 欠落時リスク |
|------|-------------|
| 支払条件 | critical |
| 著作権 | high |
| 損害賠償 | high |
| 契約解除 | medium |
| 業務内容 | medium |

#### 60日ルール計算ロジック

```
パターン1: 「納品後◯日」 → そのまま計算
パターン2: 「検収後◯日」 → 検収期間(推定20日) + 指定日数
パターン3: 「翌月末」 → 平均45日（セーフ判定だが警告）
パターン4: 「検収翌月末」 → 推定65日（違反判定）
パターン5: 「翌々月末」 → 推定75日（違反判定）
```

#### 設計判断

| 項目 | 決定 | 理由 |
|------|------|------|
| 正規表現の厳密さ | 緩め | 見逃しより誤検知が安全 |
| 検収期間の推定 | 20日 | 一般的な検収期間の中央値 |
| 結果マージ方針 | 厳しい方を採用 | ユーザー保護を優先 |
| 並列実行 | あり | 高速化のため |

---

### [2024-12-25] 既知悪質パターンDB実装

#### 意図
実際のトラブル事例やよくある危険条項をデータベース化し、類似パターンを検知。

#### 実装ファイル
- `lib/knowledge/known-bad-patterns.ts`

#### パターン例
- `bad_001`: 無限責任条項
- `bad_002`: 一方的解除権
- `bad_003`: 著作権27/28条欠落

---

### [2024-12-25] 28チェックポイント完全対応

#### 意図
ユーザーから提供された28項目のチェックポイントを100%網羅し、契約書チェックの精度を最大化する。

#### 対応マトリックス

| No | 項目名 | カテゴリ | 対応ファイル | 対応状況 |
|----|--------|----------|--------------|----------|
| 01 | 支払サイト | 修正すべき | danger-patterns.ts (payment) | ✅ 実装済 |
| 02 | 検収起算日 | 修正すべき | danger-patterns.ts (acceptance) | ✅ 追加 |
| 03 | 著作権譲渡 | 修正すべき | danger-patterns.ts (copyright) | ✅ 実装済 |
| 04 | 損害賠償 | 修正すべき | danger-patterns.ts (liability) | ✅ 実装済 |
| 05 | 中途解除 | 修正すべき | known-bad-patterns.ts | ✅ 実装済 |
| 06 | 業務範囲 | 修正すべき | danger-patterns.ts (scope) | ✅ 追加 |
| 07 | 競業避止 | 修正すべき | danger-patterns.ts (non_compete) | ✅ 拡張 |
| 08 | 契約不適合責任 | 修正すべき | danger-patterns.ts (conformity) | ✅ 追加 |
| 09 | 裁判管轄 | 修正すべき | danger-patterns.ts (jurisdiction) | ✅ 追加 |
| 10 | 再委託禁止 | 修正すべき | danger-patterns.ts (employment) | ✅ 実装済 |
| 11 | AI学習利用 | 修正すべき | danger-patterns.ts (ai_usage) | ✅ 追加 |
| 12 | みなし検収 | 追加すべき | recommended-clauses.ts | ✅ 追加 |
| 13 | 遅延利息 | 追加すべき | recommended-clauses.ts | ✅ 追加 |
| 14 | 消費税 | 追加すべき | recommended-clauses.ts | ✅ 追加 |
| 15 | 経費負担 | 追加すべき | recommended-clauses.ts | ✅ 追加 |
| 16 | 着手金 | 追加すべき | recommended-clauses.ts | ✅ 追加 |
| 17 | 中途解約精算 | 追加すべき | recommended-clauses.ts | ✅ 追加 |
| 18 | 物価・仕様変更 | 追加すべき | recommended-clauses.ts | ✅ 追加 |
| 19 | 履行遅滞免責 | その他注意 | recommended-clauses.ts | ✅ 追加 |
| 20 | AIツール利用 | その他注意 | recommended-clauses.ts | ✅ 追加 |
| 21 | 背景IP留保 | その他注意 | recommended-clauses.ts | ✅ 追加 |
| 22 | 実績公開権 | その他注意 | recommended-clauses.ts | ✅ 追加 |
| 23 | クレジット表記 | その他注意 | recommended-clauses.ts | ✅ 追加 |
| 24 | 引き抜き禁止 | その他注意 | recommended-clauses.ts | ✅ 追加 |
| 25 | 連絡対応時間 | その他注意 | recommended-clauses.ts | ✅ 追加 |
| 26 | ハラスメント解除 | その他注意 | recommended-clauses.ts | ✅ 追加 |
| 27 | 特急料金 | その他注意 | recommended-clauses.ts | ✅ 追加 |
| 28 | 自動更新 | その他注意 | recommended-clauses.ts | ✅ 追加 |

#### 新規作成ファイル

| ファイル | 役割 |
|----------|------|
| `lib/rules/recommended-clauses.ts` | 推奨条項（項目12-28）の欠落検知と追加提案 |

#### 新規追加パターン（danger-patterns.ts）

**業務範囲リスク (scope)**
- `その他甲が指示する一切の業務` → high
- `付随する業務` → medium

**契約不適合責任リスク (conformity)**
- `契約不適合責任1年` → high
- `瑕疵担保責任期間不明確` → high

**裁判管轄リスク (jurisdiction)**
- `甲の本店所在地の裁判所` → medium
- `東京/大阪地裁専属` → low

**AI学習利用リスク (ai_usage)**
- `成果物のAI学習利用` → medium

**検収起算日リスク (acceptance)**
- `検査合格日を起算点` → high
- `検収完了日を起算点` → high

#### 設計判断

| 項目 | 決定 | 理由 |
|------|------|------|
| 推奨条項のリスクレベル | high〜low | 「あると良い」レベルなのでcriticalは使わない |
| みなし検収 | high | 支払遅延の最大原因のため重要度高 |
| 中途解約精算 | high | タダ働きリスクが大きいため |
| 着手金・特急料金等 | low | ビジネス判断に近いため |

---

## 検討したが採用しなかったアイデア

### 1. 複数LLMによるクロスチェック
- **アイデア**: GPT-4とClaudeで並列解析し、結果を比較
- **不採用理由**: 
  - コストが2倍
  - レイテンシ増加
  - ルールベースで同等の効果を得られる

### 2. ユーザーによるフィードバック学習
- **アイデア**: 「この指摘は正しかった/間違っていた」のフィードバックで学習
- **不採用理由**:
  - 法的判断の正誤をユーザーが判断するのは危険
  - ファインチューニングのコスト
- **将来の可能性**: 専門家レビュー付きなら再検討

### 3. 契約書テンプレートとの差分比較
- **アイデア**: 標準的なテンプレートと比較して「逸脱」を検知
- **不採用理由**:
  - テンプレートの定義が困難
  - 業界・案件ごとに異なる
- **将来の可能性**: 業界別テンプレートDBを構築すれば有効

---

## 既知の課題と将来の改善候補

### 課題1: 複数条項の組み合わせリスク
- **現状**: 各条項を独立して評価
- **問題**: 「第5条と第8条を組み合わせると不利」のような検知ができない
- **対策案**: 全条項の関係性をグラフ化して解析

### 課題2: 業界特有のリスク
- **現状**: 汎用的なチェックのみ
- **問題**: IT業界、クリエイティブ業界などで重視すべき点が異なる
- **対策案**: 業界別プロファイルの導入

### 課題3: 契約書のバージョン管理
- **現状**: 1回限りのチェック
- **問題**: 修正後の再チェックで差分が見えない
- **対策案**: 履歴保存と差分表示機能

---

## 更新ルール

1. **機能追加時**: 「実装履歴」セクションに追記
2. **不採用時**: 「検討したが採用しなかった」に理由と共に記録
3. **課題発見時**: 「既知の課題」に追記
4. **大きな変更時**: 「アーキテクチャ変遷」にバージョン追加

---

---

### [2026-01-11] 2026年1月 ギャップ分析に基づく改善 (IMP-S1〜B3)

#### 概要
「フリーランス・クリエイターのための業務委託契約完全戦略レポート」に基づくギャップ分析を行い、実務上の交渉ポイントを網羅。

#### 改善項目

| タスクID | 内容 | 対応ファイル |
|---------|------|------------|
| IMP-S1 | フリーランス新法第3条「7項目チェック」 | `required-clauses.ts` |
| IMP-A1 | 契約類型（請負/準委任）の自動判定 | `ai-service.ts` |
| IMP-A2 | 著作権27条・28条の特掲有無チェック | `danger-patterns.ts` |
| IMP-A3 | 損害賠償「上限」条項の有無チェック | `danger-patterns.ts` |
| IMP-A4 | 検収期間の明記＆長さチェック | `danger-patterns.ts` |
| IMP-A5 | 買いたたき検出パターン強化 | `danger-patterns.ts` |
| IMP-B1 | 二次利用料に関する規定チェック | `recommended-clauses.ts` |
| IMP-B2 | 追加作業の別途見積もり規定チェック | `recommended-clauses.ts` |
| IMP-B3 | 「Yes, But話法」交渉テンプレート | `message-crafter.tsx` |

#### 詳細

**1. 著作権27条・28条の特掲 (IMP-A2)**
- 著作権譲渡条項があっても、27条（翻案権）と28条（二次的著作物利用権）が明記されていない場合に警告を出すロジックを追加。

**2. 損害賠償の上限規定 (IMP-A3)**
- 損害賠償条項があっても、「報酬額を上限とする」などの制限がない場合にリスクとして検知。

**3. 検収期間の適正化 (IMP-A4)**
- 検収期間が30日を超える、あるいは明記されていない場合のリスク検知を強化。

**4. 交渉テンプレートの高度化 (IMP-B3)**
- 単に修正を求めるだけでなく、角を立てずに主張を通すための「Yes, But話法」テンプレートを生成エンジンに組み込み。

---

*最終更新: 2026-01-11*
